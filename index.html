<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Hunger Games Multiplayer (FP Movement)</title>
<style>
  body { margin:0; overflow:hidden; cursor: none; }
  canvas { display:block; }
</style>
</head>
<body>

<script type="module">
// ----- FIREBASE MODULAR SDK -----
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase Config (Locked Mode)
const firebaseConfig = {
    apiKey: "AIzaSyC7AS5TZTnjwDQlqJntJe2I5PcTuLO506E",
    authDomain: "hungergames-1f808.firebaseapp.com",
    databaseURL: "https://hungergames-1f808-default-rtdb.firebaseio.com",
    projectId: "hungergames-1f808",
    storageBucket: "hungergames-1f808.appspot.com",
    messagingSenderId: "806026839452",
    appId: "1:806026839452:web:b73ae22cf3e750cfd53459",
    measurementId: "G-TGYV83N1CY"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ----- THREE.JS -----
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xa0a0a0);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Floor
const floorGeo = new THREE.PlaneGeometry(200,200);
const floorMat = new THREE.MeshBasicMaterial({color:0x228B22});
const floor = new THREE.Mesh(floorGeo, floorMat);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// ----- PLAYER -----
const playerId = 'player_' + Date.now() + '_' + Math.floor(Math.random()*1000);
const playerRef = ref(db, 'players/' + playerId);
const playersRef = ref(db, 'players');

const otherPlayers = {};
const myPlayer = {x:0, y:1, z:0};

// My cube
const myCubeGeo = new THREE.BoxGeometry(1,2,1);
const myCubeMat = new THREE.MeshBasicMaterial({color:0x0000ff});
const myCube = new THREE.Mesh(myCubeGeo, myCubeMat);
scene.add(myCube);

// ----- MOUSE CONTROL -----
let pitch = 0;
let yaw = 0;
let pointerLocked = false;

// Pointer lock for mouse movement
document.body.addEventListener('click', () => {
    renderer.domElement.requestPointerLock();
});

document.addEventListener('pointerlockchange', () => {
    pointerLocked = document.pointerLockElement === renderer.domElement;
});

document.addEventListener('mousemove', e => {
    if (!pointerLocked) return;
    const sensitivity = 0.002;
    yaw -= e.movementX * sensitivity;
    pitch -= e.movementY * sensitivity;
    pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
});

// ----- MOVEMENT -----
let moveForward = false;
document.addEventListener('keydown', e => {
    if(e.key.toLowerCase() === 'w') moveForward = true;
});
document.addEventListener('keyup', e => {
    if(e.key.toLowerCase() === 'w') moveForward = false;
});

// ----- FIREBASE FUNCTIONS -----
function updateFirebase() {
    set(playerRef, {
        x: myPlayer.x,
        y: myPlayer.y,
        z: myPlayer.z,
        timestamp: Date.now()
    });
    onDisconnect(playerRef).remove();
}

// Listen for other players
onValue(playersRef, snapshot => {
    const playersData = snapshot.val() || {};
    for(const id in playersData){
        if(id === playerId) continue;
        const data = playersData[id];
        if(!otherPlayers[id]){
            const geo = new THREE.BoxGeometry(1,2,1);
            const mat = new THREE.MeshBasicMaterial({color:0xff0000});
            const mesh = new THREE.Mesh(geo, mat);
            scene.add(mesh);
            otherPlayers[id] = {mesh};
        }
        otherPlayers[id].mesh.position.set(data.x,data.y,data.z);
    }
    // Remove disconnected
    for(const id in otherPlayers){
        if(!playersData[id]){
            scene.remove(otherPlayers[id].mesh);
            delete otherPlayers[id];
        }
    }
});

// ----- ANIMATE -----
const clock = new THREE.Clock();
function animate(){
    requestAnimationFrame(animate);

    const delta = clock.getDelta();
    // Move forward
    if(moveForward){
        myPlayer.x += Math.sin(yaw) * 5 * delta;
        myPlayer.z += Math.cos(yaw) * 5 * delta;
    }

    // Update my cube
    myCube.position.set(myPlayer.x,myPlayer.y,myPlayer.z);

    // Camera
    camera.position.set(myPlayer.x, myPlayer.y + 1.5, myPlayer.z);
    const lookDir = new THREE.Vector3(
        Math.sin(yaw) * Math.cos(pitch),
        Math.sin(pitch),
        Math.cos(yaw) * Math.cos(pitch)
    );
    camera.lookAt(myPlayer.x + lookDir.x, myPlayer.y + 1.5 + lookDir.y, myPlayer.z + lookDir.z);

    updateFirebase();
    renderer.render(scene, camera);
}
animate();
</script>

</body>
</html>
